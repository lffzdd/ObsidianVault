# Quota 的一般用途 
quota 比较常使用的几个情况是：

- 针对 WWW server ，例如：每个人的网页空间的容量限制！
- 针对 mail server，例如：每个人的邮件空间限制。
- 针对 file server，例如：每个人最大的可用网络硬盘空间 (教学环境中最常见！)
上头讲的是针对网络服务的设计，如果是针对 Linux 系统主机上面的设定那么使用的方向有底下这一些：

- 限制某一群组所能使用的最大磁盘配额 (使用群组限制)：你可以将你的主机上的用户分门别类，有点像是目前很流行的付费与免付费会员制的情况， 你比较喜好的那一群的使用配额就可以给高一些！
- 限制某一用户的最大磁盘配额 (使用用户限制)：在限制了群组之后，你也可以再继续针对个人来进行限制，使得同一群组之下还可以有更公平的分配！
- 限制某一目录 (directory, project) 的最大磁盘配额：在旧版的 CentOS 当中，使用的预设文件系统为 EXT 家族，这种文件系统的磁盘配额主要是针对整个文件系统来处理，所以大多针对『挂载点』进行设计。 新的 xfs 可以使用 project 这种模式，就能够针对个别的目录 (非文件系统喔) 来设计磁盘配额耶！超棒的！

基本上，quota 就是在回报管理员磁盘使用率以及让管理员管理磁盘使用情况的一个工具就是了！ 
# Quota 的使用限制
![[Pasted image 20241107174935.png]]
# Quota 的规范设定项目：
![[Pasted image 20241107175839.png]]
一般预设的宽限时间为七天，如果七天内你都不进行任何磁盘管理，那么 soft 限制值会即刻取代 hard 限值来作为 quota 的限制。
以上面设定的例子来说，假设你的容量高达 450MBytes 了，那七天的宽限时间就会开始倒数，若七天内你都不进行任何删除文件的动作来替你的磁盘用量减肥，那么七天后你的磁盘最大用量将变成 400MBytes (那个 soft 的限制值)，此时你的磁盘使用权就会被锁住而无法新增文件了。
整个 soft, hard, grace time 的相关性我们可以用底下的图示来说明
![[Pasted image 20241107180029.png]]
# 一个 XFS 文件系统的 Quota 实作范例
```shell
# 制作账号环境时，由于有五个账号，因此鸟哥使用 script 来建立环境！
[root@study ~]# vim addaccount.sh
#!/bin/bash
# 使用 script 来建立实验 quota 所需的环境
groupadd myquotagrp
for username in myquota1 myquota2 myquota3 myquota4 myquota5
do
useradd -g myquotagrp $username
echo "password" | passwd --stdin $username
done
mkdir /home/myquota
chgrp myquotagrp /home/myquota
chmod 2770 /home/myquota
[root@study ~]# sh addaccount.sh
```

## 实作 Quota 流程-1：文件系统的支持与观察
前面我们就谈到，要使用 Quota 必须要核心与文件系统支持才行！假设你已经使用了预设支持 Quota的核心，那么接下来就是要启动文件系统的支持啦！但是要注意，我们这边是以 XFS 文件系统为例的，如果你使用的是 EXT 家族，请找前一版的书籍说明喔！此外，不要在根目录底下进行 quota设计喔！因为文件系统会变得太复杂！因此，底下我们是以 /home 这个 xfs 文件系统为例的！
```shell
[root@study ~]# df -hT /home
Filesystem Type Size Used Avail Use% Mounted on
/dev/mapper/centos-home xfs 5.0G 67M 5.0G 2% /home
```
从上面的数据来看，鸟哥这部主机的 /home 确实是独立的 filesystem，而且确实是使用了 xfs 文件系统！所以可以使用底下的流程啰！此外，由于 VFAT 文件系统并不支持 Linux Quota 功能，所以我们得要使用 mount 查询一下 /home 的文件系统为何才行啊！
在过去的版本中，管理员似乎可以透过 mount -o remount 的机制来重新挂载启动 quota 的功能，不过 XFS 文件系统的 quota 似乎是在挂载之初就宣告了，因此无法使用 remount 来重新启动 quota 功能，一定得要写入 /etc/fstab 当中，或者是在初始挂载过程中加入这个项目，否则不会生效
```shell
[root@study ~]# vim /etc/fstab
/dev/mapper/centos-home /home xfs defaults,usrquota,grpquota 0 0
# 其他项目鸟哥并没有列出来！重点在于第四字段！于 default 后面加上两个参数！
[root@study ~]# umount /home
[root@study ~]# mount -a
[root@study ~]# mount | grep home
/dev/mapper/centos-home on /home type xfs (rw,relatime,seclabel,attr2,inode64,usrquota,grpquota)
```
基本上，针对 quota 限制的项目主要有三项，如下所示：
- uquota/usrquota/quota：针对使用者账号的设定
- gquota/grpquota：针对群组的设定
- pquota/prjquota：针对单一目录的设定，但是不可与 grpquota 同时存在！
修改完 /etc/fstab 后，务必要测试一下！若有发生错误得要赶紧处理！因为这个文件如果修改错误，是会造成无法开机完全的情况啊！切记切记！最好使用 vim 来修改啦！因为会有语法的检验，就不会让你写错字了！此外，由于一般用户的家目录在 /home 里面，因此针对这个项目的卸除时，一定要将所有一般账号的身份注销，否则肯定无法卸除
## 实作 Quota 流程-2：观察 Quota 报告资料
制作文件系统支持之后，当然得要来瞧一瞧到底有没有正确的将 quota 的管理数据列出来才好！这时我们得要使用 xfs_quota 这个指令才行！这个指令真的是挺复杂的，因为全部的 quota 实作都是这个指令耶！所以里面的参数有够多！不过稍微观察一下即可！先让我们来谈谈观察目前 quota 的报告内容吧！
```shell
[root@study ~]# xfs_quota -x -c "指令" [挂载点]
选项与参数：
-x ：专家模式，后续才能够加入 -c 的指令参数喔！
-c ：后面加的就是指令，这个小节我们先来谈谈数据回报的指令
指令：
print ：单纯的列出目前主机内的文件系统参数等资料
df ：与原本的 df 一样的功能，可以加上 -b (block) -i (inode) -h (加上单位) 等
report：列出目前的 quota 项目，有 -ugr (user/group/project) 及 -bi 等资料
state ：说明目前支持 quota 的文件系统的信息，有没有起动相关项目等
范例一：列出目前系统的各的文件系统，以及文件系统的 quota 挂载参数支持
[root@study ~]# xfs_quota -x -c "print"
Filesystem Pathname
/ /dev/mapper/centos-root
/srv/myproject /dev/vda4
/boot /dev/vda2
/home /dev/mapper/centos-home (uquota, gquota) # 所以这里就有显示支持啰
范例二：列出目前 /home 这个支持 quota 的载点文件系统使用情况
[root@study ~]# xfs_quota -x -c "df -h" /home
Filesystem Size Used Avail Use% Pathname
/dev/mapper/centos-home
5.0G 67.0M 4.9G 1% /home
# 如上所示，其实跟原本的 df 差不多啦！只是会更正确就是了。
范例三：列出目前 /home 的所有用户的 quota 限制值
[root@study ~]# xfs_quota -x -c "report -ubih" /home
User quota on /home (/dev/mapper/centos-home)
Blocks Inodes
User ID Used Soft Hard Warn/Grace Used Soft Hard Warn/Grace
---------- --------------------------------- ---------------------------------
root 4K 0 0 00 [------] 4 0 0 00 [------]
dmtsai 34.0M 0 0 00 [------] 432 0 0 00 [------]
…..(中间省略)…..
myquota1 12K 0 0 00 [------] 7 0 0 00 [------]
myquota2 12K 0 0 00 [------] 7 0 0 00 [------]
myquota3 12K 0 0 00 [------] 7 0 0 00 [------]
myquota4 12K 0 0 00 [------] 7 0 0 00 [------]
myquota5 12K 0 0 00 [------] 7 0 0 00 [------]
# 所以列出了所有用户的目前的文件使用情况，并且列出设定值。注意，最上面的 Block
# 代表这个是 block 容量限制，而 inode 则是文件数量限制喔。另外，soft/hard 若为 0，代表没限制
范例四：列出目前支持的 quota 文件系统是否有起动了 quota 功能？
[root@study ~]# xfs_quota -x -c "state"
User quota state on /home (/dev/mapper/centos-home)
Accounting: ON # 有启用计算功能
Enforcement: ON # 有实际 quota 管制的功能
Inode: #1568 (4 blocks, 4 extents) # 上面四行说明的是有激活 user 的限制能力
Group quota state on /home (/dev/mapper/centos-home)
Accounting: ON
Enforcement: ON
Inode: #1569 (5 blocks, 5 extents) # 上面四行说明的是有激活 group 的限制能力
Project quota state on /home (/dev/mapper/centos-home)
Accounting: OFF
Enforcement: OFF
 Inode: #1569 (5 blocks, 5 extents) # 上面四行说明的是 project 并未支持
Blocks grace time: [7 days 00:00:30] # 底下则是 grace time 的项目
Inodes grace time: [7 days 00:00:30]
Realtime Blocks grace time: [7 days 00:00:30]
```
在默认的情况下， xfs_quota 的 report 指令会将支持的 user/group/prject 相关数据列出来，如果只是想要某个特定的项目，例如我们上面要求仅列出用户的数据时，就在 report 后面加上 -u 即可喔！这样就能够观察目前的相关设定信息了。要注意，限制的项目有 block/inode 同时可以针对每个项目来设定 soft/hard 喔！接下来实际的设定看看吧
## 实作 Quota 流程-3：限制值设定方式
确认文件系统的 quota 支持顺利启用后，也能够观察到相关的 quota 限制，接下来就是要实际的给予用户/群组限制啰！回去瞧瞧，我们需要每个用户 250M/300M 的容量限制，群组共 950M/1G 的容量限制，同时 grace time 设定为 14 天喔！实际的语法与设定流程来瞧瞧：
```shell
[root@study ~]# xfs_quota -x -c "limit [-ug] b[soft|hard]=N i[soft|hard]=N name"
[root@study ~]# xfs_quota -x -c "timer [-ug] [-bir] Ndays"
选项与参数：
limit ：实际限制的项目，可以针对 user/group 来限制，限制的项目有
bsoft/bhard : block 的 soft/hard 限制值，可以加单位
isoft/ihard : inode 的 soft/hard 限制值
name : 就是用户/群组的名称啊！
timer ：用来设定 grace time 的项目喔，也是可以针对 user/group 以及 block/inode 设定

范例一：设定好用户们的 block 限制值 (题目中没有要限制 inode 啦！)
[root@study ~]# xfs_quota -x -c "limit -u bsoft=250M bhard=300M myquota1" /home
[root@study ~]# xfs_quota -x -c "limit -u bsoft=250M bhard=300M myquota2" /home
[root@study ~]# xfs_quota -x -c "limit -u bsoft=250M bhard=300M myquota3" /home
[root@study ~]# xfs_quota -x -c "limit -u bsoft=250M bhard=300M myquota4" /home
[root@study ~]# xfs_quota -x -c "limit -u bsoft=250M bhard=300M myquota5" /home
[root@study ~]# xfs_quota -x -c "report -ubih" /home
User quota on /home (/dev/mapper/centos-home)
Blocks Inodes
User ID Used Soft Hard Warn/Grace Used Soft Hard Warn/Grace
---------- --------------------------------- ---------------------------------
myquota1 12K 250M 300M 00 [------] 7 0 0 00 [------]

范例二：设定好 myquotagrp 的 block 限制值
[root@study ~]# xfs_quota -x -c "limit -g bsoft=950M bhard=1G myquotagrp" /home
[root@study ~]# xfs_quota -x -c "report -gbih" /home
Group quota on /home (/dev/mapper/centos-home)
Blocks Inodes
Group ID Used Soft Hard Warn/Grace Used Soft Hard Warn/Grace
---------- --------------------------------- ---------------------------------
myquotagrp 60K 950M 1G 00 [------] 36 0 0 00 [------]

范例三：设定一下 grace time 变成 14 天吧！
[root@study ~]# xfs_quota -x -c "timer -ug -b 14days" /home <==这里不能同时ug,只能搞一个
[root@study ~]# xfs_quota -x -c "state" /home
User quota state on /home (/dev/mapper/centos-home)
…..(中间省略)…..
Blocks grace time: [14 days 00:00:30]
Inodes grace time: [7 days 00:00:30]
Realtime Blocks grace time: [7 days 00:00:30]

范例四：以 myquota1 用户测试 quota 是否真的实际运作呢？
[root@study ~]# su - myquota1
[myquota1@study ~]$ dd if=/dev/zero of=123.img bs=1M count=310
dd: error writing ‘123.img’: Disk quota exceeded
300+0 records in
299+0 records out
314552320 bytes (315 MB) copied, 0.181088 s, 1.7 GB/s
[myquota1@study ~]$ ll -h
-rw-r--r--. 1 myquota1 myquotagrp 300M Jul 24 21:38 123.img

[myquota1@study ~]$ exit
[root@study ~]# xfs_quota -x -c "report -ubh" /home
User quota on /home (/dev/mapper/centos-home)
Blocks
User ID Used Soft Hard Warn/Grace
---------- ---------------------------------
myquota1 300M 250M 300M 00 [13 days]
myquota2 12K 250M 300M 00 [------]
# 因为 myquota1 的磁盘用量已经破表，所以当然就会出现那个可怕的 grace time 啰！
```
## 实作 Quota 流程-4：project 的限制 (针对目录限制) (Optional)
现在让我们来想一想，如果需要限制的是目录而不是群组时，那该如何处理呢？举例来说，我们要限制的是 /home/myquota 这个目录本身，而不是针对 myquotagrp 这个群组啊！这两种设定方法的意义不同喔！例如，前一个小节谈到的测试范例来说， myquota1 已经消耗了 300M 的容量，而 /home/myquota 其实还没有任何的使用量 (因为在 myquota1 的家目录做的 dd 指令)。不过如果你使用了 xfs_quota -x -c "report -h" /home 这个指令来查看，就会发现其实 myquotagrp 已经用掉了300M 了！如此一来，对于目录的限制来说，就不会有效果！
为了解决这个问题，因此我们这个小节要来设定那个很有趣的 project 项目！只是这个项目不可以跟 group 同时设定喔！因此我们得要取消 group 设定并且加入 project 设定才行。那就来实验看看。
### 修改 /etc/fstab 内的文件系统支持参数
首先，要将 grpquota 的参数取消，然后加入 prjquota ，并且卸除 /home 再重新挂载才行！那就来测试看看！
```shell
# 1. 先修改 /etc/fstab 的参数，并启动文件系统的支持
[root@study ~]# vim /etc/fstab
/dev/mapper/centos-home /home xfs defaults,usrquota,grpquota,prjquota 0 0
# 记得， grpquota 与 prjquota 不可同时设定喔！所以上面删除 grpquota 加入 prjquota
[root@study ~]# umount /home
[root@study ~]# mount -a
[root@study ~]# xfs_quota -x -c "state"
User quota state on /home (/dev/mapper/centos-home)
Accounting: ON
Enforcement: ON
Inode: #1568 (4 blocks, 4 extents)
Group quota state on /home (/dev/mapper/centos-home)
Accounting: OFF <==已经取消啰！
Enforcement: OFF
Inode: N/A
Project quota state on /home (/dev/mapper/centos-home)
Accounting: ON <==确实启动啰！
Enforcement: ON
Inode: N/A
Blocks grace time: [7 days 00:00:30]
Inodes grace time: [7 days 00:00:30]
Realtime Blocks grace time: [7 days 00:00:30]
```
