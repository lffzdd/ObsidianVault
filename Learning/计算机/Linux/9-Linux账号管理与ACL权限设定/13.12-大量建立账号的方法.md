# 账号相关检查工具
## `pwck`
pwck 检查 /etc/passwd 这个账号配置文件内的信息，与实际的家目录是否存在等信息，还可以比对 /etc/passwd /etc/shadow 的信息是否一致，
如果 /etc/passwd 内的数据字段错误时，会提示使用者修订。
```shell
[root@study ~]# pwck
user 'ftp': directory '/var/ftp' does not exist
user 'avahi-autoipd': directory '/var/lib/avahi-autoipd' does not exist
user 'pulse': directory '/var/run/pulse' does not exist
pwck: no changes

# 上面那些账号绝大部分都是系统账号，确实也不需要家目录
```
相对应的群组检查可以使用 `grpck`
## `pwconv`
这个指令主要的目的是在『将 /etc/passwd 内的账号与密码，移动到 /etc/shadow 当中
早期的 Unix ,系统当中并没有 /etc/shadow ，用户的登入密码在 /etc/passwd 的第二栏

使用 `pwconv` 后，可以：
- 比对 /etc/passwd 及 /etc/shadow ，若 /etc/passwd 内存在的账号并没有对应的 /etc/shadow 密码时，则 pwconv 会去 /etc/login.defs 取用相关的密码数据，并建立该账号的 /etc/shadow 数据；
- 若 /etc/passwd 内存在加密后的密码数据时，则 pwconv 会将该密码栏移动到/etc/shadow 内，并将原本的/etc/passwd 内相对应的密码栏变成 x ！

正常使用 `useradd` 增加使用者时，使用 `pwconv` 并不会有任何的动作,==如果手动设定账号==，这个 pwconv 就很重要
### `pwunconv`
将 /etc/shadow 内的密码栏数据写回 /etc/passwd 当中，并且删除 /etc/shadow 文件,最好不要使用
## `chpasswd`
`chpasswd` 可以『读入未加密前的密码，并且经过加密后，将加密后的密码写入 /etc/shadow 当中,很常被使用在大量建置账号的情况中
可以由 Standard input 读入数据，每笔数据的格式是『 username: password 』
```shell
# 更新密码 (update)
[root@study ~]# echo "vbird3:abcdefg" | chpasswd
```
在预设的情况中， chpasswd 会去读取 /etc/login.defs 文件内的加密机制，CentOS 7.x 用的是 SHA512，因此 chpasswd 就预设会使用 SHA512 来加密.想要使用不同的加密机制，那就得要使用 -c 以及 -e 等方式来处理
从 CentOS 5.x 开始之后，passwd 已经默认加入了 --stdin 的选项，因此这个 chpasswd 就变得无用武之地了
## 大量建置账号模板(适用 `passwd --stdin` 选项)
```shell
[root@study ~]# vim accountadd.sh
#!/bin/bash
  
# 0. userinput
usergroup=""
pwmech="openssl"    # "openssl" or "account" is needed.
homeperm="no"       # if "yes" then I will modify home dir permission to 711


# 1. check the accountadd.txt file
action="$1"     # "create" is useradd and "delete" is userdel.
if [ ! -f accountadd.txt ];then

    echo "没有 accountadd.txt 文件,退出"

    exit 1

fi

[ "$usergroup" != "" ] && groupadd -r $usergroup
rm -f outputpw.txt
usernames=$(cat accountadd.txt)
  
for username in $usernames
do
    case ${action} in
    "create")
        [ "${usergroup}" != "" ] && usegrp=" -G ${usergroup} " || usegrp=""
        useradd ${usegrp} ${username} # 新增账号
        [ "${pwmech}" == "openssl" ] && usepw=$(openssl rand -base64 6) || usepw=${username}
        echo ${usepw} | passwd --stdin ${username} # 建立密码
        chage -d 0 ${username} # 强制登入修改密码
        [ "${homeperm}" == "yes" ] && chmod 711 /home/${username}
        echo "username=${username}, password=${usepw}" >> outputpw.txt
        ;;

    "delete")
        echo "deleting ${username}"
        userdel -r ${username}
        ;;
    *)
        echo "Usage: $0 [create|delete]"
        ;;
    esac
done
```
是否需要修改密码？是否与账号相同的信息等等，你可以自由选择！若使用 openssl 自动猜密码时，用户的密码请由 outputpw.txt 去捞～鸟哥最常作的方法，就是将该文件打印出来，用裁纸机一个账号一条，交给同学即可！
```shell
[root@study ~]# vim accountadd.txt
std01
std02
std03
std04
std05
[root@study ~]# sh accountadd.sh create
Changing password for user std01.
passwd: all authentication tokens updated successfully.
….(后面省略)…
```