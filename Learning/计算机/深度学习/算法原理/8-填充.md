---
aliases: 8-填充
tags: []
date created: 星期日, 七月 7日 2024, 12:03:10 凌晨
date modified: 星期一, 七月 22日 2024, 8:48:37 晚上
---

当使用卷积神经网络中的步幅卷积（如你提到的 `Conv2D(starting_filters * 2, 2, strides=2, padding='same')`）时，步幅为 2 的卷积操作会将特征图的宽度和高度减小一半。而填充（padding）方式为 `same` 时，可以确保输出特征图的尺寸是经过计算后适当调整的，具体情况如下：
### 填充（Padding）方式的解释
1. **Valid 填充**：
   - 没有填充。卷积核只能应用于输入的完全重叠区域。
   - 输出尺寸小于输入尺寸。
   - 计算公式：
     $$
     \text{Output\_size} = \left\lfloor \frac{\text{Input\_size} - \text{Filter\_size}}{\text{Stride}} \right\rfloor + 1
     $$
2. **Same 填充**：
   - 填充方式使得输出尺寸等于输入尺寸除以步幅（向上取整）。
   - 卷积核可以应用于输入的边界区域，必要时对输入进行零填充。
   - 计算公式：
     $$
     \text{Output\_size} = \left\lceil \frac{\text{Input\_size}}{\text{Stride}} \right\rceil
     $$
### 应用 `same` 填充和步幅为 2 的卷积
#### 示例
假设输入图像大小为 (8, 8)，卷积核大小为 (2, 2)，步幅为 2，填充方式为 `same`：
1. **计算输出尺寸**：
   根据 `same` 填充的定义，输出尺寸的计算公式为：
   $$
   \text{Output\_size} = \left\lceil \frac{\text{Input\_size}}{\text{Stride}} \right\rceil
   $$
   对于输入尺寸 (8, 8) 和步幅 2：
   $$
   \text{Output\_height} = \left\lceil \frac{8}{2} \right\rceil = 4
   $$
   $$
   \text{Output\_width} = \left\lceil \frac{8}{2} \right\rceil = 4
   $$
   因此，输出特征图的大小为 (4, 4)。
2. **填充计算**：
   为了实现 `same` 填充，卷积操作需要在输入的边界添加适当的零填充，使得输出尺寸为 (4, 4)。具体填充量的计算如下：
   - 计算总填充量：
     $$
     \text{Total\_padding} = (\text{Output\_size} - 1) \times \text{Stride} + \text{Filter\_size} - \text{Input\_size}
     $$
     $$
     \text{Total\_padding} = (4 - 1) \times 2 + 2 - 8 = 0
     $$
   - 水平和垂直方向各分配的填充量：
     $$
     \text{Padding\_height} = \left\lfloor \frac{\text{Total\_padding\_height}}{2} \right\rfloor = 0
     $$
     $$
     \text{Padding\_width} = \left\lfloor \frac{\text{Total\_padding\_width}}{2} \right\rfloor = 0
     $$
   由于填充量为 0，意味着不需要额外填充。
#### 代码示例
以下是使用步幅为 2 和 `same` 填充的卷积层示例：

```python
import tensorflow as tf
from tensorflow.keras.layers import Conv2D
from tensorflow.keras.models import Model
input_layer = tf.keras.layers.Input(shape=(8, 8, 1))  # 输入尺寸为 (8, 8, 1)
conv_layer = Conv2D(filters=2, kernel_size=(2, 2), strides=2, padding='same')(input_layer)
model = Model(inputs=input_layer, outputs=conv_layer)
model.summary()
```

### 总结
使用步幅为 2 的卷积操作时，特征图的宽度和高度会减小一半。通过 `same` 填充，可以确保输出特征图的尺寸经过调整后合适。具体填充量由 TensorFlow 或 Keras 自动计算，确保在步幅卷积操作后，特征图的空间尺寸仍然适合网络的进一步处理。
[python] 填充量的计算确保输出特征图的尺寸按照预期的方式调整，特别是当使用 `same` 填充时，目标是保持输出特征图的空间尺寸与输入特征图相同（或按步幅调整后的尺寸）。以下是详细解释和计算公式。
# 填充量的计算原理
#### 目标
- **Same 填充**：确保输出特征图的尺寸按步幅调整后的大小。
#### 公式
对于给定的输入尺寸 $ \text{Input\_size} $、卷积核大小 $ \text{Filter\_size} $、步幅 $ \text{Stride} $，和所需的输出尺寸 $ \text{Output\_size} $，填充量的计算公式如下：
$$
\text{Output\_size} = \left\lceil \frac{\text{Input\_size}}{\text{Stride}} \right\rceil
$$
$$
\text{Total\_padding} = (\text{Output\_size} - 1) \times \text{Stride} + \text{Filter\_size} - \text{Input\_size}
$$
每一侧的填充量：
$$
\text{Padding\_before} = \left\lfloor \frac{\text{Total\_padding}}{2} \right\rfloor
$$
$$
\text{Padding\_after} = \text{Total\_padding} - \text{Padding\_before}
$$
### 示例计算
假设输入尺寸为 $8 \times 8$，卷积核大小为 $2 \times 2$，步幅为 2，填充方式为 `same`。
1. **计算输出尺寸**：
$$
\text{Output\_size} = \left\lceil \frac{8}{2} \right\rceil = 4
$$
2. **计算总填充量**：
$$
\text{Total\_padding} = (4 - 1) \times 2 + 2 - 8 = 0
$$
3. **每一侧的填充量**：
$$
\text{Padding\_before} = \left\lfloor \frac{0}{2} \right\rfloor = 0
$$
$$
\text{Padding\_after} = 0 - 0 = 0
$$
因为总填充量为 0，意味着不需要额外填充。
### 更复杂的例子
假设输入尺寸为 $9 \times 9$，卷积核大小为 $3 \times 3$，步幅为 2，填充方式为 `same`。
1. **计算输出尺寸**：
$$
\text{Output\_size} = \left\lceil \frac{9}{2} \right\rceil = 5
$$
2. **计算总填充量**：
$$
\text{Total\_padding} = (5 - 1) \times 2 + 3 - 9 = 2
$$
3. **每一侧的填充量**：
$$
\text{Padding\_before} = \left\lfloor \frac{2}{2} \right\rfloor = 1
$$
$$
\text{Padding\_after} = 2 - 1 = 1
$$
因此，每一侧需要填充 1 个像素。
### 验证计算

```python
import tensorflow as tf
from tensorflow.keras.layers import Conv2D
from tensorflow.keras.models import Model
input_layer = tf.keras.layers.Input(shape=(9, 9, 1))  # 输入尺寸为 (9, 9, 1)
conv_layer = Conv2D(filters=2, kernel_size=(3, 3), strides=2, padding='same')(input_layer)
model = Model(inputs=input_layer, outputs=conv_layer)
model.summary()
```

输出特征图的尺寸应该为 $5\times 5$，每一侧填充 1 个像素。
### 总结
填充量的计算是为了确保输出特征图的尺寸符合预期，特别是当使用 `same` 填充时，输出特征图的尺寸按步幅调整。计算公式的核心在于确定总填充量并将其均匀分配到输入特征图的每一侧。通过这种方式，卷积操作可以正确处理输入的边界，确保输出特征图的尺寸与设计相符。
