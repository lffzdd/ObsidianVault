---
aliases:
  - 4.3-Anchor框匹配到BBox
tags: 
date created: Saturday, September 14th 2024, 8:49:30 pm
date modified: Saturday, September 14th 2024, 8:51:52 pm
---
- ? 经过 nms 后，anchor 框会经过 rot 池化，然后再进行分开进行分类预测和边框回归，可是，一个图片有很多个 anchor，然后图片的 bbox 只有几个，我怎么知道 anchor 框会和哪个 Bbox 计算损失函数用于更新迭代参数，又怎么知道它该属于哪个类别，毕竟它本身只是一个区域框，标记的类别也只有前景和后景之分，就算是前景，我怎么训练它让它对标某个 Bbox 及其分类？
---
这是一个很好的问题，也是理解 Faster R-CNN 和类似目标检测模型的核心部分。我们来一步步分析这些问题，从 Anchor 框与实际标注的边界框 (BBox) 的匹配，到如何进行分类和边界框回归。
### 1. Anchor 框如何匹配到 Ground Truth BBox
在训练过程中，模型需要知道哪些 Anchor 框与实际的目标（即 Ground Truth BBox）匹配，从而在训练时计算损失函数。具体的匹配策略如下：
#### a. IOU 匹配策略
Faster R-CNN 使用 **IoU (Intersection over Union)** 来决定 Anchor 框与 Ground Truth BBox 的匹配情况。
- **正样本 (Positive samples)**：如果 Anchor 框与 Ground Truth BBox 的 IoU 大于某个阈值（例如 0.7），则将这个 Anchor 标记为正样本，并认为它对应于该 BBox。
- **负样本 (Negative samples)**：如果 Anchor 框与所有 Ground Truth BBox 的 IoU 小于某个较低的阈值（例如 0.3），则将这个 Anchor 标记为负样本，表示它只包含背景。
- **忽略样本**：介于这两个阈值之间的 Anchor 框（例如 0.3 < IoU < 0.7），不用于训练（被忽略），这样可以避免模型学习到不确定的边界情况。
这样，通过 IoU，我们可以找到哪些 Anchor 框与某个 Ground Truth BBox 匹配，哪些不匹配。这一步为后续的分类和回归损失打下了基础。
### 2. Anchor 框如何学习分类
一旦 Anchor 框被标记为正样本或负样本，它们就会用来计算分类损失。
- **负样本**：标记为背景的 Anchor 框（即 IoU 小于 0.3 的 Anchor 框）将用于训练模型识别背景。
- **正样本**：与某个 Ground Truth BBox 有较高 IoU 的 Anchor 框（例如 IoU 大于 0.7）会标记为正样本。这些 Anchor 框不仅要学习预测为前景，还要预测出正确的物体类别。
对于正样本，模型会通过分类分支预测每个 Anchor 框所属的物体类别。类别信息来自于 Ground Truth BBox 的标签。例如，如果一个 Anchor 框匹配到 Ground Truth 中的 " 猫 "，那么这个 Anchor 框的目标分类就是 " 猫 "，模型在训练时将尝试将该 Anchor 分类为 " 猫 "。
#### 分类损失的计算
分类损失通常使用交叉熵损失来衡量模型对 Anchor 分类的准确性。公式如下：
$$
L_{cls}(p_i, p_i^*) = -\frac{1}{N} \sum_{i} \left[ p_i^* \log(p_i) + (1 - p_i^*) \log(1 - p_i) \right]
$$
其中：
- $p_i$ 是模型预测的类别概率。
- $p_i^*$ 是实际的 Ground Truth 类别标签（例如，背景为 0，猫为 1）。
- $N$ 是正样本和负样本的总数。
### 3. Anchor 框如何进行边界框回归
对于那些被标记为正样本的 Anchor 框，不仅要分类正确，还需要精确地回归到与目标边界框 (Ground Truth BBox) 更接近的位置。
#### a. 目标边界框的回归目标
模型不会直接预测 BBox 的绝对坐标，而是预测 Anchor 框相对于 Ground Truth BBox 的**位移偏差**。即模型需要学习预测 Anchor 框的调整参数，使得它们更接近 Ground Truth BBox。
边界框回归预测的参数是以下四个值：
- 中心点的偏移量：$t_x, t_y$
- 宽度和高度的缩放比例：$t_w, t_h$
具体公式如下：
$$
t_x = \frac{(x_{\text{gt}} - x_{\text{anchor}})}{w_{\text{anchor}}}, \quad
t_y = \frac{(y_{\text{gt}} - y_{\text{anchor}})}{h_{\text{anchor}}}
$$
$$
t_w = \log\left(\frac{w_{\text{gt}}}{w_{\text{anchor}}}\right), \quad
t_h = \log\left(\frac{h_{\text{gt}}}{h_{\text{anchor}}}\right)
$$
其中 $(x_{\text{gt}}, y_{\text{gt}}, w_{\text{gt}}, h_{\text{gt}})$ 是 Ground Truth 边界框的坐标和尺寸，$(x_{\text{anchor}}, y_{\text{anchor}}, w_{\text{anchor}}, h_{\text{anchor}})$ 是 Anchor 框的坐标和尺寸。
通过这样的偏移计算，模型学习如何从 Anchor 框回归到 Ground Truth 边界框。
#### b. 边界框回归损失
回归损失通常使用平滑 L1 损失 (Smooth L1 Loss)，它在接近目标时是 L2 损失，而在远离目标时是 L1 损失。公式如下：
$$
L_{reg}(t_i, t_i^*) = \text{SmoothL1}(t_i - t_i^*)
$$
其中 $ t_i $ 是模型预测的边界框回归参数，$ t_i^* $ 是实际的偏移量（根据 Ground Truth BBox 和 Anchor 框计算得到的值）。
### 4. 损失函数的合并
在 Faster R-CNN 中，最终的总损失函数是分类损失和边界框回归损失的加权组合：
$$
L(\{p_i\}, \{t_i\}) = \frac{1}{N_{cls}} \sum_i L_{cls}(p_i, p_i^*) + \lambda \frac{1}{N_{reg}} \sum_i p_i^* L_{reg}(t_i, t_i^*)
$$
- $L_{cls}(p_i, p_i^*)$：分类损失，用于判断 Anchor 是否属于前景或背景，并识别正样本的具体类别。
- $L_{reg}(t_i, t_i^*)$：边界框回归损失，用于调整 Anchor 框的位置，使之更接近 Ground Truth BBox。
- $\lambda$：用于平衡分类和回归损失的权重。
通过这种方式，模型同时学习如何分类 Anchor 框以及如何回归其边界框。
### 5. 总结
简而言之，Anchor 框通过 IoU 与 Ground Truth BBox 进行匹配，确定哪些 Anchor 框是正样本、哪些是负样本。对于正样本，模型不仅要学习正确的物体类别，还要通过边界框回归使 Anchor 框更加准确地贴合 Ground Truth BBox。训练过程中的损失函数结合了分类损失和回归损失，帮助模型逐步提升分类准确性和定位精度。
