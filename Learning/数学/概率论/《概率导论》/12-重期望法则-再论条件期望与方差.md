```ad-tip
title:总结本节要点如下.
collapse:open

**条件期望和条件方差的性质**
- $\operatorname{E}[X|Y=y]$ 的值依赖于 $y.$
- $\operatorname{E}[X|Y]$ 是随机变量 $Y$ 的函数，因此它也是一个随机变量.当 $Y$ 的值为 $y$ 时，它的值就等于 $E[X|Y=y].$
- ~ $\operatorname{E}[\operatorname{E}[X|Y]]=\operatorname{E}[X]$ (重期望法则).
- $\operatorname{E}[X|Y=y]$可视为已知$Y=y$时对$X$的估计.相应的估计误差$\operatorname{E}[X|Y]-X$是一个零均值的随机变量，且与 $\mathbb{E}[X|Y]$ 是不相关的.
- $\mathrm{var}(X|Y)$ 也是个随机变量，当 $Y$ 的值为 $y$ 时它的值就等于 $\mathrm{var}(X|Y=y).$
- ~ $\operatorname{var}(X)=\operatorname{E}[\operatorname{var}(X|Y)]+\operatorname{var}(\operatorname{E}[X|Y])$(全方差法则).
```

# 重期望法则
假设我们在投掷一个不均匀的硬币，正面朝上的概率，记为$Y$,也是随机的. 假定正面朝上的概率$Y$的分布为已知，它是[0,1]上的分布. 现在我们投掷$n$次硬币，定义$x$为正面朝上的总次数.由于对任意的$y\in[0,1]$,我们有$\mathbb{E}[X|Y=y]=ny$,所
以 $E[X|Y]$ 是随机变量 $nY.$
既然$\mathbb{E}[X|Y]$是一个随机变量，那么就应该有自己的期望$\mathbb{E}[\mathbb{E}[X|Y]]$。使用期望法则，
可得
$$\mathrm{E}[\mathrm{E}[X|Y]]=\begin{cases}\sum\limits_{y}\mathrm{E}[X|Y=y]p_Y(y),&Y\text{ 离散},\\\\\int\limits_{-\infty}^{\infty}\mathrm{E}[X|Y=y]f_Y(y)\mathrm{d}y,&Y\text{ 连续}.\end{cases}$$
右边的两个表达式在第2章和第3章中都非常熟悉. 使用全期望定理，它们都等于$\mathbb{E}[X]$ 这样我们就可以得出如下结论：不管随机变量$Y$是离散的、连续的、或混合的，只要随机变量 $\chi$ 具有有限的期望 E[X],下面的法则成立.
重期望法则： $E[\mathbb{E}[X|Y]]=\mathbb{E}[X].$

下面使用实例来说明如何运用重期望法则来计算涉及条件概率的问题中的期望值.
![[Pasted image 20240910165121.png]]
# 条件期望作为估计量
如果我们将 $Y$ 视为能提供关于 $X$ 的信息的观测值，则我们很自然地将条件期望作为给定 $Y$ 的条件下对 $X$ 的估计，记为
$$
\hat{X}=\mathrm{E}[X|Y].
$$
这样，估计误差就定义为
$$\tilde{X}=\hat{X}-X.$$
显然估计误差也是随机变量，且满足
$$\operatorname{E}[\tilde{X}|Y]=\operatorname{E}[(\hat{X}-X)|Y]=\operatorname{E}[\hat{X}|Y]-\operatorname{E}[X|Y]=\hat{X}-\hat{X}=0.$$
所以随机变量$\mathbb{E}[\tilde{X}|Y]$恒为0：对任意的$y$, $\mathbb{E}[\tilde{X}|Y=y]=0.$运用重期望法则，还可以
得到
$$\mathrm{E}[\tilde{X}]=\mathrm{E}[\mathrm{E}[\tilde{X}|Y]]=0.$$
这就表明估计误差没有系统性的正或负的偏倚.
下面接着证明具有另一个有趣的性质：**它与估计误差 $\tilde{X}$ 是不相关的** . 事实上 , 运用重期望法则，可得
$$\mathrm{E}[\hat{X}\:\tilde{X}]=\mathrm{E}[\mathrm{E}[\hat{X}\:\tilde{X}\:|Y]]=\mathrm{E}[\hat{X}\mathrm{E}[\tilde{X}|Y]]=0,$$
最后两个等式成立的原因是$\hat{X}$完全由$Y$确定，所以
$$\operatorname{E}[\hat{X}\:\tilde{X}|Y]=\hat{X}\operatorname{E}[\tilde{X}|Y]=0.$$
从而
$$\mathrm{cov}(\hat{X},\tilde{X})=\mathrm{E}[\hat{X}\tilde{X}]-\mathrm{E}[\hat{X}]\mathrm{E}[\tilde{X}]=0-\mathrm{E}[X]\cdot0=0,$$
故$\hat{X}$与$\tilde{X}$是不相关的.
基于 $\mathrm{cov}(\hat{X},\tilde{X})=0$ 这个结论，又注意到 $X=\hat{X}+\tilde{X}$,两边取方差，我们可以得到
- ~  $$\mathrm{var}(X)=\mathrm{var}(\hat{X})+\mathrm{var}(\tilde{X}).$$
上面这个等式，可以表述为一个有用的法则，下面我们开始讨论这个法则.
# 条件方差
首先介绍随机变量
$$\mathrm{var}(X|Y)=\mathrm{E}[(X-\mathrm{E}[X|Y])^2|Y]=E[(X-\hat{X})^{2}|Y]=\mathrm{E}[\tilde{X}^2|Y].$$
这是一个关于$Y$的函数，对于给定的$Y$值$y$,它等于在已知$\{Y=y\}$的条件下，$X$的条件方差为
$$\operatorname{var}(X|Y=y)=\operatorname{E}[\tilde{X}^{2}|Y=y].$$
- @ 在 $Y=y$ 的条件下，$X$ 的方差，等于 $X$ 的估计误差平方的期望
利用结论$\mathbb{E}[\tilde{X}]=0$ 和重期望法则，我们可以将估计误差的方差写成
$$\mathrm{var}(\tilde{X})=\mathrm{E}[\tilde{X}^{2}]=\mathrm{E}[\mathrm{E}[\tilde{X}^{2}|Y]]=\mathrm{E}[\mathrm{var}(X|Y)],$$
所以等式 $\operatorname{var}(X)=\operatorname{var}(\tilde{X})+\operatorname{var}(\hat{X})$ 就可以写为如下形式.
全方差法则：$\mathrm{var}(X)=\mathrm{E}[\mathrm{var}(X|Y)]+\mathrm{var}(\mathrm{E}[X|Y]).$
- @ $X$ 的方差等于 $X|Y$ 的方差的期望加上期望的方差

下面举例说明全方差法则对计算随机变量的方差非常有用
![[Pasted image 20240910165018.png]]
![[Pasted image 20240910165029.png]]